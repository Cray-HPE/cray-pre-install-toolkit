#!/bin/bash
set -e

function extra_setup {
    local password=initial0
    echo DEMO: Adding Ansible Vault credentials...
    test -f /etc/ansible && rm /etc/ansible
    test ! -d /etc/ansible && mkdir /etc/ansible
    echo "$password" > /etc/ansible/.vault.txt

    echo DEMO: Extracting WASP platform.yml and networks.yml
    pushd / && tar -xzvf /wasp-demo-configs.tar.gz 2>/dev/null && head /etc/motd && popd

    echo "DEMO: Setting 'airgap' to False; enabling NEXUS"
    sed -i 's/^airgap:.*/airgap: no/' /opt/cray/crayctl/files/group_vars/all/metal.yml
}

time extra_setup
echo DEMO: Initializing Ansible
time crayctl-init-ansible
echo DEMO: Deploying stage1
time crayctl deploy stage1
echo DEMO: PXE Installing NCN nodes
time crayctl pxe-install
echo DEMO: Deploing stage2
time crayctl deploy stage2
echo DEMO: END
